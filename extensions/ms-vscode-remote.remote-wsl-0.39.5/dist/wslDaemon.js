!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=93)}({1:function(e,t){e.exports=require("path")},10:function(e,t){e.exports=require("util")},11:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(1),r=n(4),o=n(2),i=n(6),c=n(7),a=n(10);function l(){const e=process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432"),t=process.env.SystemRoot;if(t)return s.join(t,e?"Sysnative":"System32","wslconfig.exe")}let u,d;function f(){if("number"!=typeof u){const e=/(\d+)\.(\d+)\.(\d+)/g.exec(r.release());u=e&&4===e.length?parseInt(e[3]):0}return u}t.WIN10_1903_LABEL="Windows 10, May 2019 Update, version 1903",t.WIN10_1803_LABEL="Windows 10, April 2018 Update, version 1803",t.isDistroEnvVarAvailable=function(){return f()>=18362},t.isWSLPathAvailable=function(){return f()>=17046},t.isWSLEnvAvailable=function(){return f()>=17063},t.isDistributionArgumentSupported=function(){return f()>=17666},t.isExecArgumentSupported=function(){return f()>=17666},t.getWSLExecutablePath=function(){let e=f()>=16299;const t=process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432"),n=process.env.SystemRoot;if(n)return s.join(n,t?"Sysnative":"System32",e?"wsl.exe":"bash.exe")},t.getWSLConfigExecutablePath=l,t.getWindowsBuildNumber=f,t.getProductConfiguration=function(e){if(!d){const t=o.readFileSync(s.join(e,"product.json")).toString();d=JSON.parse(t)}return d};const h=/^[\w\d+\.\-_~!$&'\(\)\*\+,;=]+$/,p="+".charCodeAt(0);function S(e,t){return e.length===t.length&&(e===t||e.toLowerCase()===t.toLowerCase())}t.DEFAULT_AUTHORITY="wsl+default",t.ALPINE_AUTHORITY="wsl+Alpine",t.ALPINE_DISTRO="Alpine",t.getAuthorityFromDistro=function(e){return e?h.test(e)&&"default"!==e&&e.charCodeAt(0)!==p?"wsl+"+e:"wsl++"+Buffer.from(e,"utf8").toString("hex"):t.DEFAULT_AUTHORITY},t.compareCaseInsensitive=S,t.isEqualAuthority=function(e,t){return S(e,t)},t.getDistroFromAuthority=function(e){if(/^wsl\+/.test(e)){const t=e.substr(4);return"default"===t?void 0:t.charCodeAt(0)===p?Buffer.from(t.substr(1),"hex").toString("utf8"):t}throw new Error("authority must start with wsl+")},t.getDistros=function(){return new Promise((e,t)=>{const n=l();n?i.execFile(n,["/list"],{windowsVerbatimArguments:!0,encoding:"utf16le"},(n,s,r)=>{if(n)t(n);else{const t=/\r\n/.test(s)?"\r\n":"\n",n=s.split(t);let r=[];for(let e=1;e<n.length;e++){let t=n[e].match(/^[a-zA-Z0-9\.\-_]+/);t&&r.push(t[0])}e(r)}}):t(new Error("Unable to find location of wslconfig.exe"))})},t.toForwardSlashes=function(e){return e.replace(/[\\\/]/g,s.posix.sep)},t.escapeQuotes=function(e){return e.replace(/'/g,"'\"'\"'")},t.donwloadBuild=async function(e,n,r,i){await async function e(t){await a.promisify(o.exists)(t)||(await e(s.dirname(t)),await a.promisify(o.mkdir)(t))}(s.dirname(r));const l=n&&S(n,t.ALPINE_DISTRO)?"server-linux-alpine":"server-linux-x64",u=`${e.updateUrl}/commit:${e.commit}/${l}/${e.quality||"insider"}`,d=`${r}_${Date.now()}`;return function e(t,n,s,r=5){return new Promise((i,a)=>{const l=o.createWriteStream(n),u=c.get(t,o=>{if(r>0&&(o.statusCode>=300&&o.statusCode<=303||307===o.statusCode)){let t=o.headers.location;if(t)return void e(t,n,s,r-1).then(i,a)}if(o.statusCode<200||o.statusCode>299)return void a(`Failed to download VS Code Server from ${t}: HTTP ${o.statusCode} - ${o.statusMessage}`);const c=parseInt(o.headers["content-length"]||"0");let u=0;c&&o.on("data",e=>{u+=e.length,s(u,c)}),o.on("error",a),o.pipe(l),o.on("end",i)});u.on("error",a)})}(u,d,i).then(e=>a.promisify(o.rename)(d,r).then(e=>r))},t.getServerTarCacheLocation=function(e,n){return n&&S(n,t.ALPINE_DISTRO)?s.join(r.tmpdir(),"vscode-remote-wsl",e.commit,"vscode-server-linux-alpine.tar.gz"):s.join(r.tmpdir(),"vscode-remote-wsl",e.commit,"vscode-server-linux-x64.tar.gz")}},2:function(e,t){e.exports=require("fs")},4:function(e,t){e.exports=require("os")},6:function(e,t){e.exports=require("child_process")},7:function(e,t){e.exports=require("https")},93:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(94),r=n(6),o=n(2),i=n(4),c=n(11),a=n(1),l=n(95),u=process.env.VSCODE_WSL_AGENT_DEBUG_PORT,d=process.env.VSCODE_WSL_PIPE_NAME,f=parseInt(process.env.VSCODE_WSL_EXT_HOST_PID||"0",10),h=process.env.VSCODE_WSL_EXT_LOCATION,p=process.env.VSCODE_WSL_APP_ROOT,S=!!process.env.VSCODE_WSL_ENABLE_TELEMETRY,_=process.env.VSCODE_FILE_WATCHER_POLLING||0,g=process.env.VSCODE_WSL_DISTRO,w=!!process.env.VSCODE_WSL_DEBUG_INFO;class v{constructor(e,t){this.increment=e,this.message=t,this.type="progressMessage"}}t.ProgressMessage=v;class m{constructor(e){this.data=e,this.type="stdoutMessage"}}t.StdoutMessage=m;class L{constructor(e){this.data=e,this.type="stderrMessage"}}t.StderrMessage=L;class E{constructor(e,t,n){this.host=e,this.port=t,this.wslVersion=n,this.type="portResolved"}}t.PortResolvedMessage=E;class O{constructor(e,t){this.message=e,this.wslVersion=t,this.type="fatalErrorOccured"}}t.FatalErrorOccuredMessage=O;let y=null,C=[];function A(e){for(let t=0;t<C.length;t++)C[t]===e&&C.splice(t,1);0===C.length&&process.exit(0)}!function(){const e=new class{send(e){process.stdout.write(JSON.stringify(e)+"\n")}};C.push(e);let t=setInterval(function(){try{process.kill(f,0)}catch(n){clearInterval(t),A(e)}},1e3)}();const b=s.createServer(e=>{const t=new l.SimpleProtocol(e),n=new class{send(e){t.send(e)}};C.push(n),t.onMessage=(()=>{throw new Error("Received unexpected message")}),y&&n.send(y),e.on("close",()=>{A(n)})});function P(e){e&&"EADDRINUSE"===e.code||(console.error(e),process.exit(0));let t=e=>{console.error(e),process.exit(0)},n=s.createConnection(d,()=>{n.removeListener("error",t),new l.SimpleProtocol(n).onMessage=(e=>{x(e)}),n.on("close",()=>{process.exit(0)})});n.once("error",t)}function x(e){C.forEach(t=>{t.send(e)})}function T(e){const t=i.networkInterfaces(),n={};for(let e in t)for(let s of t[e])n[s.address]=!0;return e.length&&!e.some(e=>n[e])?e[0]:"127.0.0.1"}b.on("error",P),b.listen(d,async()=>{let e;b.removeListener("error",P);let t="",n=0,s="",i=[],l="";const d=t=>{clearTimeout(e),x(y=new O(t,l))},f=e=>{const t=e.match(/(\d+)%$/);let r=0;if(t){const e=Math.min(parseInt(t[1],10),100);0===e&&(n=0),e>n&&(r=e-n,n=e)}(s!==e||r>0)&&(s=e,x(new v(r/2,e)))},C=()=>{let n=!1;if(I)I=!1,W=0,D&&(x(new v(0,"Installing WSL components")),D=!1);else if(++W>300)return void d(`VS Code Server for WSL failed to start. No messages received for ${Math.floor(90)}s`);return A.length&&(x(new m(A)),n=(n=>{for(let s=0;s<n.length;s++){const r=n.charCodeAt(s);if(10===r){let n=t.match(/Extension host agent listening on (\d+)/);if(n)return clearTimeout(e),x(y=new E(T(i),parseInt(n[1],10),l)),!0;(n=t.match(/IP Address: ([\d\.]+)/))?i.push(n[1]):(n=t.match(/WSL version: (.+)/))&&(l=n[1]),f(t),t=""}else 8===r?10!==t.charCodeAt(t.length-1)&&(t=t.substr(0,t.length-1)):t+=n.charAt(s)}return f(t),!1})(A),A=""),$.length&&(x(new L($)),$=""),n};let A="",$="",I=!1,W=0,D=!0;e=setInterval(C,300);const V=c.getWSLExecutablePath();if(!V||!o.existsSync(V))return void d(`VS Code Server for WSL failed. '${V}' not found.\n\nMake sure WSL is installed:\nhttps://aka.ms/vscode-remote/wsl/install-wsl`);const M=c.getProductConfiguration(p),{commit:R,quality:N,serverDataFolderName:k}=M;if(R&&!N)return void d(`VSCode Client (${p}) does not define a quality.`);const B=k||".vscode-remote",j=c.isWSLEnvAvailable();let U="";if(R&&j&&(U=c.getServerTarCacheLocation(M,g),!o.existsSync(U)))try{if(function(e,t,n,s){let o;const i=`[ -d ~/${n}/bin/${s} ] && echo found || echo missing`;if(c.isExecArgumentSupported()){const n=t?`-d ${t}`:"";o=`${e} ${n} -e sh -c "${i}"`}else o=`${e} ${i}`;return x(new m(`Probing if server is already installed: ${o}`)),-1!==r.execSync(o,{stdio:[null,null,null]}).toString().indexOf("found")}(V,g,B,R))U="",x(new m("Server install found in WSL"));else{x(new m(`No server install found on WSL, downloading server on client side: ${U}`));let e=0;await c.donwloadBuild(M,g,U,(t,n)=>{const s=Math.ceil(50*t/n);s>e&&(x(new v(s-e,"Downloading server...")),e=s)})}}catch(e){x(new L(`Unable to detect if server is already installed: ${e}`)),U=""}const F=u?`--inspect=0.0.0.0:${u}`:"";let H=R?`"${j?"$VSCODE_WSL_EXT_LOCATION":"."}/scripts/wslServer.sh" ${R} ${N} ${B} ${_} ${F} ${S?"":"--disable-telemetry"}`:`"$VSCODE_WSL_EXT_LOCATION/scripts/wslServer-dev.sh" "$VSCODE_WSL_APP_ROOT" ${_} ${F}`;const q=[];w&&(H="env && VSCODE_WSL_DEBUG_INFO=true "+H),H=`'${H}'`,c.isDistributionArgumentSupported()?(g&&q.push("-d",g),q.push("sh","-c",H)):"wsl.exe"===a.basename(V).toLowerCase()?q.push("sh","-c",H):q.push("-c",H),x(new m(`Launching ${V} ${q.join(" ")} in ${h}`));const X={...process.env};if(j||!R){const e=[];X.VSCODE_WSL_EXT_LOCATION=h,e.push("VSCODE_WSL_EXT_LOCATION/up"),U&&(X.VSCODE_SERVER_TAR=U,e.push("VSCODE_SERVER_TAR/up")),R||(X.VSCODE_WSL_APP_ROOT=p,e.push("VSCODE_WSL_APP_ROOT/up")),X.WSLENV&&e.push(`${X.WSLENV}`),X.WSLENV=e.join(":")}const G=r.spawn(V,q,{cwd:h,env:X,windowsVerbatimArguments:!0});G.stdout.on("data",e=>{A+=e.toString(),I=!0}),G.stderr.on("data",e=>{$+=e.toString(),I=!0}),G.on("error",e=>{C()||d(`VS Code Server for WSL failed with error:\r\n${e.message}`)}),G.on("close",e=>{C()||d("VS Code Server for WSL closed unexpectedly.")})})},94:function(e,t){e.exports=require("net")},95:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SimpleProtocol=class{constructor(e){this.onMessage=null,this.onClose=null,this._byteProtocol=new s(e),this._byteProtocol.onClose=(()=>{this.onClose&&this.onClose()}),this._byteProtocol.onMessage=(e=>{if(!this.onMessage)throw new Error("Incorrect usage!");this.onMessage(JSON.parse(e.toString()))})}send(e){this._byteProtocol.send(Buffer.from(JSON.stringify(e)))}};class s{constructor(e){this._socket=e,this._writeBuffer=new class{constructor(){this._data=[],this._totalLength=0}add(e,t){const n=0===this._totalLength;return this._data.push(e,t),this._totalLength+=e.length+t.length,n}take(){const e=Buffer.concat(this._data,this._totalLength);return this._data.length=0,this._totalLength=0,e}},this._chunks=[],this.onMessage=null,this.onClose=null;let t=0;const n={readHead:!0,bodyLen:-1};this._socketDataListener=(e=>{for(this._chunks.push(e),t+=e.length;t>0;){if(n.readHead){if(!(t>=s._headerLen))break;{const e=Buffer.concat(this._chunks);n.bodyLen=e.readUInt32BE(0),n.readHead=!1;const r=e.slice(s._headerLen);t=r.length,this._chunks=[r]}}if(!n.readHead){if(!(t>=n.bodyLen))break;{const e=Buffer.concat(this._chunks),s=e.slice(0,n.bodyLen),r=e.slice(n.bodyLen);if(t=r.length,this._chunks=[r],n.bodyLen=-1,n.readHead=!0,!this.onMessage)throw new Error("Incorrect usage!");this.onMessage(s)}}}}),e.on("data",this._socketDataListener),this._socketCloseListener=(()=>{this.onClose&&this.onClose()}),e.once("close",this._socketCloseListener)}send(e){const t=Buffer.allocUnsafe(s._headerLen);t.writeUInt32BE(e.length,0,!0),this._writeSoon(t,e)}_writeSoon(e,t){this._writeBuffer.add(e,t)&&setImmediate(()=>{this._socket.destroyed||this._socket.write(this._writeBuffer.take())})}}s._headerLen=4,t.ByteProtocol=s}}));
//# sourceMappingURL=wslDaemon.js.map